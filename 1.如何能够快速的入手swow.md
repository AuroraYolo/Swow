# ä»€ä¹ˆæ˜¯swow?

Swow è‡´åŠ›äºä½¿ç”¨æœ€å° C æ ¸å¿ƒåŠå¤šæ•° PHP ä»£ç ä»¥æ”¯æŒ PHP é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ï¼Œè¿™å†³å®šäº†å®ƒåœ¨ä¿éšœå…³é”®æ€§èƒ½ä¹‹å¤–ï¼Œæ›´å¤šçš„æ˜¯é€šè¿‡ PHP ä»£ç ä¸
C å†…æ ¸çš„æ— ç¼èåˆè¿ä½œï¼Œæä¾›å¼ºå¤§çš„äºŒæ¬¡å¼€å‘èƒ½åŠ›ã€‚

æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›äº†ä¸°å¯Œå¤šæ ·çš„è°ƒè¯•æœºåˆ¶ä¸å¼ºå¤§ä¸”ä½é—¨æ§›çš„è°ƒè¯•å·¥å…·ï¼Œæœ€å¤§ç¨‹åº¦åœ°ç¡®ä¿å¼€å‘è€…å…å— BUG å›°æ‰°ï¼Œæ™®é€šå¼€å‘è€…ä¹Ÿèƒ½é€šè¿‡å·¥å…·çš„åŠ æŒå…·å¤‡æ¥è¿‘ä¸“å®¶çº§åˆ«çš„
DEBUG èƒ½åŠ›ï¼Œä»è€Œå°†å¼€å‘æ•ˆç‡æœ€å¤§åŒ–.

ä¸€å¥è¯æ€»ç»“å°±æ˜¯ğŸ®ğŸº

# å…·æœ‰çš„ç‰¹æ€§

1. ğŸš€åç¨‹
2. âš¡ï¸é«˜æ€§èƒ½âš¡ï¸
3. ğŸ’«é«˜å¯æ§ğŸ’«
4. ğŸŒŸæ˜“å…¼å®¹ğŸŒŸ

æ›´å¤šçš„ä»‹ç»è¯´æ˜å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.toast.run/swow/chs/)

# å®‰è£…swow

## ğŸ¤ªæœ€(sha)èª(ç“œ)æ˜(å¼)çš„å®‰è£…æ–¹æ³•

1. composer å¼•å…¥swow

```shell
composer require swow/swow
```

2. å¿«é€Ÿæ‰§è¡Œå®‰è£…å‘½ä»¤

```shell
php vendor/bin/swow-builder
```

3. å®‰è£…å®Œæ¯•åæ‰§è¡Œ php --ri swow

```shell
php --ri swow

Swow

Status => enabled
Author => Swow Team
Link => https://github.com/swow/swow
Contact => Twosee <twosee@php.net>
Version => 1.2.0 ( NTS )
Built => Mar 13 2023 23:27:03
Context => boost-context
Scheduler => libuv-event
SSL => OpenSSL 3.0.3 3 May 2022 (built with OpenSSL 1.1.1q  5 Jul 2022)
cURL => libcurl/7.83.1 (SecureTransport) OpenSSL/1.1.1q zlib/1.2.11 brotli/1.0.9 zstd/1.5.2 libidn2/2.3.3 libssh2/1.10.0 nghttp2/1.47.0 librtmp/2.3 OpenLDAP/2.6.2

```

æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ä½ å·²ç»å®‰è£…æˆåŠŸäº†.
å…³äºæ›´å¤šçš„å®‰è£…æ–¹å¼,æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æŸ¥çœ‹[å®‰è£…æ–‡æ¡£](https://docs.toast.run/swow/chs/install.html)

# ä½¿ç”¨åç¨‹

## ğŸ˜åç¨‹çš„æ¦‚å¿µ

æ¥è‡ª`ChatGPT`çš„å›ç­”:

* `åç¨‹`
  ï¼ˆCoroutineï¼‰æ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å¹¶å‘è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿè¢«ç§°ä¸ºç”¨æˆ·æ€çº¿ç¨‹æˆ–è€…çº¤ç¨‹ï¼ˆfiberï¼‰ã€‚å®ƒæ˜¯ä¸€ç§å•çº¿ç¨‹ã€éæŠ¢å å¼çš„å¹¶å‘å®ç°æ–¹å¼ï¼Œå¤šä¸ªåç¨‹å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å¹¶å‘æ‰§è¡Œï¼Œä½†æ¯ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªåç¨‹åœ¨è¿è¡Œã€‚åç¨‹é€šè¿‡ä¿å­˜å½“å‰æ‰§è¡ŒçŠ¶æ€ï¼Œå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»æš‚åœæ‰§è¡Œï¼Œå¹¶é€šè¿‡æ¢å¤æ‰§è¡ŒçŠ¶æ€æ¥å®ç°å¼‚æ­¥/åŒæ­¥çš„ä»£ç é€»è¾‘ã€‚
*
* åç¨‹çš„ä¸»è¦ä¼˜ç‚¹æ˜¯ï¼š


* 1.`æ›´åŠ è½»é‡çº§`ï¼šç›¸å¯¹äºçº¿ç¨‹ï¼Œåç¨‹çš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬æ›´ä½ï¼Œä¸”å ç”¨çš„å†…å­˜æ›´å°ã€‚

* 2.`æ— éœ€æ˜¾å¼çš„é”æœºåˆ¶`ï¼šç”±äºåç¨‹æ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦åƒå¤šçº¿ç¨‹ç¼–ç¨‹é‚£æ ·è€ƒè™‘é”çš„é—®é¢˜ï¼Œé¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹å®¹æ˜“å‡ºç°çš„æ­»é”ã€ç«æ€ç­‰å¹¶å‘é—®é¢˜ã€‚

* 3.`é«˜æ•ˆçš„ä¸Šä¸‹æ–‡åˆ‡æ¢`ï¼šåç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€è¿œå°äºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› æ­¤åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹åç¨‹çš„æ€§èƒ½è¡¨ç°æ›´å¥½ã€‚

* 4.`æ›´åŠ çµæ´»`ï¼šåç¨‹çš„è°ƒåº¦å¯ä»¥ç”±ç¨‹åºå‘˜è‡ªè¡Œæ§åˆ¶ï¼Œå› æ­¤å¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯çµæ´»é…ç½®ï¼Œæé«˜ç¨‹åºçš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

* å¸¸è§çš„åç¨‹åº“åŒ…æ‹¬Pythonçš„`gevent`ã€PHPçš„`Swoole`ç­‰ã€‚

## å¦‚ä½•ä½¿ç”¨

`Swow\Coroutine::run`

```php
Swow\Coroutine::run(static function (): void {
    echo  1;
    sleep(1);
});
```

## è·å–å½“å‰åç¨‹

`\Swow\Coroutine::getCurrent();`

```php
Swow\Coroutine::run(static function (): void {
    var_dump(\Swow\Coroutine::getCurrent());
});

//console
object(Swow\Coroutine)#3 (5) {
  ["id"]=>
  int(2)
  ["state"]=>
  string(7) "running"
  ["switches"]=>
  int(0)
  ["elapsed"]=>
  string(3) "0ms"
  ["trace"]=>
  string(331) "
#0 [internal function]: Swow\Coroutine->__debugInfo()
#1 /Users/heping/PhpWorkSpace/swow-cloud/swow/examples/coroutine/debug.php(15): var_dump(Object(Swow\Coroutine))
#2 [internal function]: {closure}()
#3 /Users/heping/PhpWorkSpace/swow-cloud/swow/examples/coroutine/debug.php(16): Swow\Coroutine::run(Object(Closure))
#4 {main}
"
}
```

## åç¨‹çŠ¶æ€

`waiting`ã€`running`ã€`dead`

1. `waiting` ä»£è¡¨åç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶åç¨‹å¯èƒ½åˆšè¢«åˆ›å»ºå‡ºæ¥ä½†è¿˜æ²¡æœ‰è¢«å”¤é†’ï¼Œä¹Ÿå¯èƒ½æ˜¯ç”±äº I/Oæ“ä½œ è®©å‡ºäº†ï¼Œç­‰å¾…è¢« I/O äº‹ä»¶å”¤é†’ã€‚

```php
$coroutine = Swow\Coroutine::run(static function (): void {
    \Swow\Coroutine::yield();
});
var_dump($coroutine);
//console
object(Swow\Coroutine)#3 (5) {
  ["id"]=>
  int(2)
  ["state"]=>
  string(7) "waiting"
  ["switches"]=>
  int(1)
  ["elapsed"]=>
  string(3) "0ms"
  ["trace"]=>
  string(151) "
#0 /Users/heping/PhpWorkSpace/swow-cloud/swow/examples/coroutine/debug.php(15): Swow\Coroutine::yield()
#1 [internal function]: {closure}()
#2 {main}
"
}

````

2. `running` ä»£è¡¨åç¨‹æ­£åœ¨è¿è¡Œ

```php
$coroutine = Swow\Coroutine::run(static function (): void {
    echo 1;
    var_dump(\Swow\Coroutine::getCurrent());
});

//console
object(Swow\Coroutine)#3 (5) {
  ["id"]=>
  int(2)
  ["state"]=>
  string(7) "running"
  ["switches"]=>
  int(0)
  ["elapsed"]=>
  string(3) "0ms"
  ["trace"]=>
  string(331) "
#0 [internal function]: Swow\Coroutine->__debugInfo()
#1 /Users/heping/PhpWorkSpace/swow-cloud/swow/examples/coroutine/debug.php(16): var_dump(Object(Swow\Coroutine))
#2 [internal function]: {closure}()
#3 /Users/heping/PhpWorkSpace/swow-cloud/swow/examples/coroutine/debug.php(17): Swow\Coroutine::run(Object(Closure))
#4 {main}
"
}

```

3`dead` ä»£è¡¨åç¨‹ä»è¿è¡Œçš„å‡½æ•°ä¸­è¿”å›ï¼Œä¸”ææ„å‡½æ•°ä¹Ÿå·²ç»è¿è¡Œå®Œæ¯•ï¼Œå³å·²ç»å®Œå…¨é€€å‡º

```php
$coroutine = Swow\Coroutine::run(static function (): void {
    echo 1;
});
var_dump($coroutine);

1object(Swow\Coroutine)#3 (4) {
  ["id"]=>
  int(2)
  ["state"]=>
  string(4) "dead"
  ["switches"]=>
  int(1)
  ["elapsed"]=>
  string(3) "0ms"
}

```

# Channel

åç¨‹é‡Œçš„channelæ˜¯ä¸€ç§ç”¨äºåœ¨ä¸åŒåç¨‹ä¹‹é—´ä¼ é€’æ•°æ®çš„é€šä¿¡æœºåˆ¶ã€‚
å®ƒå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è¢«å‘é€æˆ–è€…æ¥æ”¶ã€‚åç¨‹å¯ä»¥é€šè¿‡å‘é€å’Œæ¥æ”¶æ¥æ“ä½œè¿™äº›å…ƒç´ ï¼Œä»è€Œå®ç°å¹¶å‘ç¼–ç¨‹å’Œåä½œå¼å¤šä»»åŠ¡å¤„ç†ã€‚

```php
$channel = new \Swow\Channel();

$coroutine = Swow\Coroutine::run(static function () use($channel): void {
    $channel->push(1); //å¾€channelæ¨é€1
});

\Swow\Coroutine::run(function () use($channel): void    {
   var_dump($channel->pop());//æ¥æ”¶channelé€šé“é‡Œçš„å€¼
});
//console
1(int)
```

## ç”¨channelç›‘å¬CTRL+Cäº‹ä»¶

```php

$channel = new \Swow\Channel();
\Swow\Coroutine::run(static function () use ($channel): void {
    \Swow\Signal::wait(\Swow\Signal::INT);
    $channel->push("Terminated by SIGINT\n");
});

\Swow\Coroutine::run(static function () use ($channel): void {
    while (true){
        sleep(1);
    }
});
echo "Wait...\n";
$timeout = 5;
try {
    echo $channel->pop($timeout * 1000);
} catch (\Swow\ChannelException $exception) {
    echo sprintf("Timeout after %d seconds\n", $timeout);
}
//console

Wait...
^CTerminated by SIGINT

```

# åˆ©ç”¨swowæ­å»ºhttpæœåŠ¡





